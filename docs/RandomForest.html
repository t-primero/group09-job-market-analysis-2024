<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.34">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>randomforest â€“ Geographic &amp; Remote Work Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-c8ad9e5dbd60b7b70b38521ab19b7da4.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-93b10530f83a0ed64c0288fd832e80ab.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Geographic &amp; Remote Work Analysis</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./introduction.html"> 
<span class="menu-text">Research Introduction</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./geographic_trends.html"> 
<span class="menu-text">Geographic Trends</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./eda.html"> 
<span class="menu-text">EDA and Visualizations</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./tech_hub_analysis.html"> 
<span class="menu-text">Tech Hub Analysis</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./skill_gap_analysis.html"> 
<span class="menu-text">Skill Gap Analysis</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./RandomForest.html" aria-current="page"> 
<span class="menu-text">Random Forest</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
        
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>




<p>Regression Analysis</p>
<div id="716685db" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> SparkSession</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Start a Spark session</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>spark <span class="op">=</span> SparkSession.builder.appName(<span class="st">"JobPostingsAnalysis"</span>).getOrCreate()</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the CSV file into a Spark DataFrame</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> spark.read.option(<span class="st">"header"</span>, <span class="st">"true"</span>).option(<span class="st">"inferSchema"</span>, <span class="st">"true"</span>).option(<span class="st">"multiLine"</span>,<span class="st">"true"</span>).option(<span class="st">"escape"</span>, <span class="st">"</span><span class="ch">\"</span><span class="st">"</span>).csv(<span class="st">"data/raw/lightcast_job_postings.csv"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Register the DataFrame as a temporary SQL view</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>df.createOrReplaceTempView(<span class="st">"job_postings"</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">#df.show(5)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>WARNING: Using incubator modules: jdk.incubator.vector
Using Spark's default log4j profile: org/apache/spark/log4j2-defaults.properties
Setting default log level to "WARN".
To adjust logging level use sc.setLogLevel(newLevel). For SparkR, use setLogLevel(newLevel).
25/10/14 16:29:36 WARN NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable
[Stage 1:&gt;                                                          (0 + 1) / 1]                                                                                25/10/14 16:29:51 WARN SparkStringUtils: Truncated the string representation of a plan since it was too large. This behavior can be adjusted by setting 'spark.sql.debug.maxToStringFields'.</code></pre>
</div>
</div>
<p>Data Preparation &amp; Cleaning</p>
<div id="d7d56083" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cleaning REMOTE_TYPE_NAME column</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Missing values are replaced</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> when, col, trim</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.withColumn(</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"REMOTE_TYPE"</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    when(col(<span class="st">"REMOTE_TYPE"</span>) <span class="op">==</span> <span class="dv">3</span>, <span class="st">"Hybrid"</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    .when(col(<span class="st">"REMOTE_TYPE"</span>) <span class="op">==</span> <span class="dv">1</span>, <span class="st">"Remote"</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    .when(col(<span class="st">"REMOTE_TYPE"</span>) <span class="op">==</span> <span class="dv">2</span>, <span class="st">"Onsite"</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    .otherwise(<span class="st">"Onsite"</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.withColumn(</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MIN_EDULEVELS"</span>,</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    when(col(<span class="st">"MIN_EDULEVELS"</span>) <span class="op">==</span> <span class="dv">99</span>, <span class="st">"Associate or lower"</span>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    .when(col(<span class="st">"MIN_EDULEVELS"</span>) <span class="op">==</span> <span class="dv">0</span>, <span class="st">"Associate or lower"</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    .when(col(<span class="st">"MIN_EDULEVELS"</span>) <span class="op">==</span> <span class="dv">1</span>, <span class="st">"Associate or lower"</span>)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    .when(col(<span class="st">"MIN_EDULEVELS"</span>) <span class="op">==</span> <span class="dv">2</span>, <span class="st">"Bachelor"</span>)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    .when(col(<span class="st">"MIN_EDULEVELS"</span>) <span class="op">==</span> <span class="dv">3</span>, <span class="st">"Master's"</span>)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    .when(col(<span class="st">"MIN_EDULEVELS"</span>) <span class="op">==</span> <span class="dv">4</span>, <span class="st">"PhD"</span>)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    .otherwise(<span class="st">"Associate or lower"</span>)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.withColumn(</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CITY_NAME"</span>,</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    when((col(<span class="st">"CITY_NAME"</span>).isNull()),<span class="st">"No City"</span>)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    .otherwise(col(<span class="st">"CITY_NAME"</span>))</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.withColumn(</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"STATE_NAME"</span>,</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    when((col(<span class="st">"STATE_NAME"</span>).isNull()),<span class="st">"No City"</span>)</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    .otherwise(col(<span class="st">"STATE_NAME"</span>))</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="74bd274f" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure numeric columns are of float type</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.withColumn(<span class="st">"SALARY"</span>, col(<span class="st">"SALARY"</span>).cast(<span class="st">"float"</span>)) <span class="op">\</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    .withColumn(<span class="st">"SALARY_FROM"</span>, col(<span class="st">"SALARY_FROM"</span>).cast(<span class="st">"float"</span>)) <span class="op">\</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    .withColumn(<span class="st">"SALARY_TO"</span>, col(<span class="st">"SALARY_TO"</span>).cast(<span class="st">"float"</span>)) <span class="op">\</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    .withColumn(<span class="st">"MIN_YEARS_EXPERIENCE"</span>, col(<span class="st">"MIN_YEARS_EXPERIENCE"</span>).cast(<span class="st">"float"</span>)) <span class="op">\</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    .withColumn(<span class="st">"MAX_YEARS_EXPERIENCE"</span>, col(<span class="st">"MAX_YEARS_EXPERIENCE"</span>).cast(<span class="st">"float"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="4d446834" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Removing any remaining NA values and selecting relevant columns for random forest analysis</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> col, <span class="bu">pow</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.feature <span class="im">import</span> VectorAssembler, StandardScaler, StringIndexer, OneHotEncoder</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml <span class="im">import</span> Pipeline</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop the NA values in relevant columns</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>rf_df <span class="op">=</span> df.dropna(subset<span class="op">=</span>[</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MIN_YEARS_EXPERIENCE"</span>,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SALARY"</span>, </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"REMOTE_TYPE"</span>,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"STATE_NAME"</span>,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MIN_EDULEVELS"</span>,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NAICS2_NAME"</span>,</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>]).select(</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MIN_YEARS_EXPERIENCE"</span>,</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SALARY"</span>, </span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"REMOTE_TYPE"</span>,</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"STATE_NAME"</span>,</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MIN_EDULEVELS"</span>,</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NAICS2_NAME"</span>,</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><strong>Why select these variables?</strong></p>
<p>The goal of using these variables is to be able to identify how much wieght/impact locations (such as state) has on the salary, in comparison to other variables such as years of experience.</p>
<p><strong>Random Forest Model Deployment</strong></p>
<div id="9a3c950c" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml <span class="im">import</span> Pipeline</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.feature <span class="im">import</span> StringIndexer, OneHotEncoder, VectorAssembler</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.regression <span class="im">import</span> RandomForestRegressor</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.evaluation <span class="im">import</span> RegressionEvaluator</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> col</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.types <span class="im">import</span> DoubleType</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Use only categoricals</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>categorical_columns <span class="op">=</span> [<span class="st">"REMOTE_TYPE"</span>, <span class="st">"STATE_NAME"</span>, <span class="st">"MIN_EDULEVELS"</span>, <span class="st">"NAICS2_NAME"</span>]</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Index -&gt; OHE -&gt; Assemble</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>indexers <span class="op">=</span> [StringIndexer(inputCol<span class="op">=</span>c, outputCol<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_idx"</span>, handleInvalid<span class="op">=</span><span class="st">"keep"</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> c <span class="kw">in</span> categorical_columns]</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>encoders <span class="op">=</span> [OneHotEncoder(inputCol<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_idx"</span>, outputCol<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_ohe"</span>)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> c <span class="kw">in</span> categorical_columns]</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>assembler <span class="op">=</span> VectorAssembler(inputCols<span class="op">=</span>[<span class="ss">f"</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">_ohe"</span> <span class="cf">for</span> c <span class="kw">in</span> categorical_columns],</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>                            outputCol<span class="op">=</span><span class="st">"features"</span>)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Model</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>rf <span class="op">=</span> RandomForestRegressor(featuresCol<span class="op">=</span><span class="st">"features"</span>, labelCol<span class="op">=</span><span class="st">"SALARY"</span>,</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>                           numTrees<span class="op">=</span><span class="dv">300</span>, maxDepth<span class="op">=</span><span class="dv">12</span>, seed<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> Pipeline(stages<span class="op">=</span>indexers <span class="op">+</span> encoders <span class="op">+</span> [assembler, rf])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="54b76f12" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>rf <span class="op">=</span> RandomForestRegressor(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    featuresCol<span class="op">=</span><span class="st">"features"</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    labelCol<span class="op">=</span><span class="st">"SALARY"</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    numTrees<span class="op">=</span><span class="dv">300</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    maxDepth<span class="op">=</span><span class="dv">12</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    seed<span class="op">=</span><span class="dv">42</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> Pipeline(stages<span class="op">=</span>indexers <span class="op">+</span> encoders <span class="op">+</span> [assembler, rf])</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co">#Train / Test Split - Using 80% of data for training and 20% for testing</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>train_df, test_df <span class="op">=</span> rf_df.randomSplit([<span class="fl">0.8</span>, <span class="fl">0.2</span>], seed<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit and Predict</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> pipeline.fit(train_df)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> model.transform(test_df)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co"># RMSE, MAE, R squared</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> metric <span class="kw">in</span> [<span class="st">"rmse"</span>, <span class="st">"mae"</span>, <span class="st">"r2"</span>]:</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    ev <span class="op">=</span> RegressionEvaluator(labelCol<span class="op">=</span><span class="st">"SALARY"</span>, predictionCol<span class="op">=</span><span class="st">"prediction"</span>, metricName<span class="op">=</span>metric)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(metric.upper(), <span class="st">"="</span>, ev.evaluate(pred))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 2:&gt;                                                          (0 + 1) / 1]                                                                                [Stage 8:&gt;                                                          (0 + 1) / 1]                                                                                [Stage 14:&gt;                                                         (0 + 1) / 1]                                                                                [Stage 20:&gt;                                                         (0 + 1) / 1]                                                                                [Stage 26:&gt;                                                         (0 + 1) / 1]                                                                                [Stage 27:&gt;                                                         (0 + 1) / 1]                                                                                [Stage 28:&gt;                                                         (0 + 1) / 1]                                                                                [Stage 30:&gt;                                                         (0 + 1) / 1]                                                                                [Stage 32:&gt;                                                         (0 + 1) / 1]                                                                                25/10/14 16:30:48 WARN DAGScheduler: Broadcasting large task binary with size 1118.7 KiB
[Stage 34:&gt;                                                         (0 + 1) / 1]                                                                                25/10/14 16:30:53 WARN DAGScheduler: Broadcasting large task binary with size 2009.6 KiB
[Stage 36:&gt;                                                         (0 + 1) / 1][Stage 37:&gt;                                                         (0 + 1) / 1]                                                                                25/10/14 16:31:01 WARN DAGScheduler: Broadcasting large task binary with size 3.3 MiB
[Stage 38:&gt;                                                         (0 + 1) / 1][Stage 39:&gt;                                                         (0 + 1) / 1]                                                                                25/10/14 16:31:09 WARN DAGScheduler: Broadcasting large task binary with size 5.0 MiB
[Stage 40:&gt;                                                         (0 + 1) / 1][Stage 41:&gt;                                                         (0 + 1) / 1]                                                                                25/10/14 16:31:21 WARN DAGScheduler: Broadcasting large task binary with size 7.2 MiB
[Stage 42:&gt;                                                         (0 + 1) / 1]25/10/14 16:31:34 WARN DAGScheduler: Broadcasting large task binary with size 1026.2 KiB
[Stage 43:&gt;                                                         (0 + 1) / 1]                                                                                25/10/14 16:31:36 WARN DAGScheduler: Broadcasting large task binary with size 9.8 MiB
[Stage 44:&gt;                                                         (0 + 1) / 1]25/10/14 16:31:48 WARN DAGScheduler: Broadcasting large task binary with size 1203.7 KiB
[Stage 45:&gt;                                                         (0 + 1) / 1]                                                                                25/10/14 16:31:51 WARN DAGScheduler: Broadcasting large task binary with size 12.6 MiB
[Stage 46:&gt;                                                         (0 + 1) / 1]25/10/14 16:32:03 WARN DAGScheduler: Broadcasting large task binary with size 1389.0 KiB
[Stage 47:&gt;                                                         (0 + 1) / 1]                                                                                [Stage 48:&gt;                                                         (0 + 0) / 1]25/10/14 16:32:05 WARN DAGScheduler: Broadcasting large task binary with size 15.9 MiB
[Stage 48:&gt;                                                         (0 + 1) / 1]25/10/14 16:32:22 WARN DAGScheduler: Broadcasting large task binary with size 1551.4 KiB
[Stage 49:&gt;                                                         (0 + 1) / 1]                                                                                [Stage 50:&gt;                                                         (0 + 0) / 1]25/10/14 16:32:25 WARN DAGScheduler: Broadcasting large task binary with size 19.4 MiB
[Stage 50:&gt;                                                         (0 + 1) / 1]25/10/14 16:32:43 WARN DAGScheduler: Broadcasting large task binary with size 1716.3 KiB
[Stage 51:&gt;                                                         (0 + 1) / 1]                                                                                [Stage 52:&gt;                                                         (0 + 1) / 1]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>RMSE = 38837.40532573633</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 53:&gt;                                                         (0 + 1) / 1]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>MAE = 30066.577004432453</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 54:&gt;                                                         (0 + 1) / 1]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R2 = 0.19334552245056114</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                </code></pre>
</div>
</div>
<p><em>Interpretation</em></p>
<p>These variables collectively explain the salary by about 20%. Whereas in the testing data, the tested salaries were off by ~39K compared to the actuals.</p>
<p><strong>Feature Importance</strong></p>
<div id="8ac129bf" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>rf_stage <span class="op">=</span> model.stages[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>importances <span class="op">=</span> np.array(rf_stage.featureImportances.toArray())</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>meta <span class="op">=</span> pred.schema[<span class="st">"features"</span>].metadata[<span class="st">"ml_attr"</span>][<span class="st">"attrs"</span>]</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>attrs <span class="op">=</span> <span class="bu">sorted</span>([<span class="op">*</span>meta.get(<span class="st">"binary"</span>, []), <span class="op">*</span>meta.get(<span class="st">"numeric"</span>, [])], key<span class="op">=</span><span class="kw">lambda</span> a: a[<span class="st">"idx"</span>])</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>feature_names <span class="op">=</span> [a[<span class="st">"name"</span>] <span class="cf">for</span> a <span class="kw">in</span> attrs]</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>topn <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>feat_imp <span class="op">=</span> (pd.DataFrame({<span class="st">"Feature"</span>: feature_names, <span class="st">"Importance"</span>: importances})</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>              .sort_values(<span class="st">"Importance"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>              .head(topn))</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>sns.barplot(data<span class="op">=</span>feat_imp, x<span class="op">=</span><span class="st">"Importance"</span>, y<span class="op">=</span><span class="st">"Feature"</span>)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f"Top </span><span class="sc">{</span>topn<span class="sc">}</span><span class="ss"> Random Forest Feature Importances"</span>)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Importance"</span>)<span class="op">;</span> plt.ylabel(<span class="st">"Feature"</span>)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RandomForest_files/figure-html/cell-8-output-1.png" width="1000" height="566" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Despite a relatively lower R squared value below 20% - this chart clearly shows that state (and ultimately location) has less influence on the amount of salary an employee receives compared to their education, position, and field. These three factors can be summarized as the amount of skill an employee has, and how much demand is required for said skill.</p>
<p><strong>Predictive Analysis (Extra Credit)</strong></p>
<p>This analysis uses test/fake data to estimate what the Random Forest model would predict the salaries to be. There are 10 different variations of job type, state, education, etc. to predict each salary.</p>
<div id="61b16839" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> functions <span class="im">as</span> F</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>cat_cols <span class="op">=</span> [<span class="st">"REMOTE_TYPE"</span>, <span class="st">"STATE_NAME"</span>, <span class="st">"MIN_EDULEVELS"</span>, <span class="st">"NAICS2_NAME"</span>]</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>num_cols <span class="op">=</span> [<span class="st">"MIN_YEARS_EXPERIENCE"</span>]</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Generic data to test predictive analysis</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>test_data <span class="op">=</span> [</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"REMOTE_TYPE"</span>: <span class="st">"Onsite"</span>, <span class="st">"STATE_NAME"</span>: <span class="st">"California"</span>, <span class="st">"MIN_EDULEVELS"</span>: <span class="st">"Master's"</span>,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>     <span class="st">"NAICS2_NAME"</span>: <span class="st">"Information"</span>, <span class="st">"MIN_YEARS_EXPERIENCE"</span>: <span class="fl">7.0</span>},</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"REMOTE_TYPE"</span>: <span class="st">"Remote"</span>, <span class="st">"STATE_NAME"</span>: <span class="st">"Texas"</span>, <span class="st">"MIN_EDULEVELS"</span>: <span class="st">"Associate or lower"</span>,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>     <span class="st">"NAICS2_NAME"</span>: <span class="st">"Administrative and Support and Waste Management and Remediation Services"</span>, <span class="st">"MIN_YEARS_EXPERIENCE"</span>: <span class="fl">2.0</span>},</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"REMOTE_TYPE"</span>: <span class="st">"Onsite"</span>, <span class="st">"STATE_NAME"</span>: <span class="st">"Washington"</span>, <span class="st">"MIN_EDULEVELS"</span>: <span class="st">"Bachelor"</span>,</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>     <span class="st">"NAICS2_NAME"</span>: <span class="st">"Professional, Scientific, and Technical Services"</span>, <span class="st">"MIN_YEARS_EXPERIENCE"</span>: <span class="fl">12.0</span>},</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"REMOTE_TYPE"</span>: <span class="st">"Hybrid"</span>, <span class="st">"STATE_NAME"</span>: <span class="st">"Illinois"</span>, <span class="st">"MIN_EDULEVELS"</span>: <span class="st">"Bachelor"</span>,</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>     <span class="st">"NAICS2_NAME"</span>: <span class="st">"Finance and Insurance"</span>, <span class="st">"MIN_YEARS_EXPERIENCE"</span>: <span class="fl">6.0</span>},</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"REMOTE_TYPE"</span>: <span class="st">"Onsite"</span>, <span class="st">"STATE_NAME"</span>: <span class="st">"New York"</span>, <span class="st">"MIN_EDULEVELS"</span>: <span class="st">"Master's"</span>,</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>     <span class="st">"NAICS2_NAME"</span>: <span class="st">"Educational Services"</span>, <span class="st">"MIN_YEARS_EXPERIENCE"</span>: <span class="fl">10.0</span>},</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"REMOTE_TYPE"</span>: <span class="st">"Hybrid"</span>, <span class="st">"STATE_NAME"</span>: <span class="st">"Florida"</span>, <span class="st">"MIN_EDULEVELS"</span>: <span class="st">"Bachelor"</span>,</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>     <span class="st">"NAICS2_NAME"</span>: <span class="st">"Manufacturing"</span>, <span class="st">"MIN_YEARS_EXPERIENCE"</span>: <span class="fl">8.0</span>},</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"REMOTE_TYPE"</span>: <span class="st">"Onsite"</span>, <span class="st">"STATE_NAME"</span>: <span class="st">"Ohio"</span>, <span class="st">"MIN_EDULEVELS"</span>: <span class="st">"Associate or lower"</span>,</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>     <span class="st">"NAICS2_NAME"</span>: <span class="st">"Health Care and Social Assistance"</span>, <span class="st">"MIN_YEARS_EXPERIENCE"</span>: <span class="fl">3.0</span>},</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"REMOTE_TYPE"</span>: <span class="st">"Onsite"</span>, <span class="st">"STATE_NAME"</span>: <span class="st">"Virginia"</span>, <span class="st">"MIN_EDULEVELS"</span>: <span class="st">"PhD"</span>,</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>     <span class="st">"NAICS2_NAME"</span>: <span class="st">"Professional, Scientific, and Technical Services"</span>, <span class="st">"MIN_YEARS_EXPERIENCE"</span>: <span class="fl">9.0</span>},</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"REMOTE_TYPE"</span>: <span class="st">"Remote"</span>, <span class="st">"STATE_NAME"</span>: <span class="st">"Colorado"</span>, <span class="st">"MIN_EDULEVELS"</span>: <span class="st">"Bachelor"</span>,</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>     <span class="st">"NAICS2_NAME"</span>: <span class="st">"Real Estate and Rental and Leasing"</span>, <span class="st">"MIN_YEARS_EXPERIENCE"</span>: <span class="fl">7.0</span>},</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"REMOTE_TYPE"</span>: <span class="st">"Onsite"</span>, <span class="st">"STATE_NAME"</span>: <span class="st">"Michigan"</span>, <span class="st">"MIN_EDULEVELS"</span>: <span class="st">"Bachelor"</span>,</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>     <span class="st">"NAICS2_NAME"</span>: <span class="st">"Wholesale Trade"</span>, <span class="st">"MIN_YEARS_EXPERIENCE"</span>: <span class="fl">5.0</span>},</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>new_df <span class="op">=</span> spark.createDataFrame(test_data)</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Preventative for nulls in categoricals your pipeline indexes</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>new_df <span class="op">=</span> new_df.fillna({c: <span class="st">"Unknown"</span> <span class="cf">for</span> c <span class="kw">in</span> cat_cols})</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicting the salaries using trained pipeline model</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> model.transform(new_df)</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>pred.select(<span class="op">*</span>cat_cols, <span class="op">*</span>num_cols, F.col(<span class="st">"prediction"</span>).alias(<span class="st">"predicted_salary"</span>)).show(truncate<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 55:&gt;                                                         (0 + 1) / 1]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>+-----------+----------+------------------+------------------------------------------------------------------------+--------------------+------------------+
|REMOTE_TYPE|STATE_NAME|MIN_EDULEVELS     |NAICS2_NAME                                                             |MIN_YEARS_EXPERIENCE|predicted_salary  |
+-----------+----------+------------------+------------------------------------------------------------------------+--------------------+------------------+
|Onsite     |California|Master's          |Information                                                             |7.0                 |170894.85297213428|
|Remote     |Texas     |Associate or lower|Administrative and Support and Waste Management and Remediation Services|2.0                 |114544.86580019069|
|Onsite     |Washington|Bachelor          |Professional, Scientific, and Technical Services                        |12.0                |140036.93253450037|
|Hybrid     |Illinois  |Bachelor          |Finance and Insurance                                                   |6.0                 |121486.09323532102|
|Onsite     |New York  |Master's          |Educational Services                                                    |10.0                |75674.94831376836 |
|Hybrid     |Florida   |Bachelor          |Manufacturing                                                           |8.0                 |123385.13022711083|
|Onsite     |Ohio      |Associate or lower|Health Care and Social Assistance                                       |3.0                 |102082.35197408112|
|Onsite     |Virginia  |PhD               |Professional, Scientific, and Technical Services                        |9.0                 |230041.21206285967|
|Remote     |Colorado  |Bachelor          |Real Estate and Rental and Leasing                                      |7.0                 |111828.60134917914|
|Onsite     |Michigan  |Bachelor          |Wholesale Trade                                                         |5.0                 |113658.3199482272 |
+-----------+----------+------------------+------------------------------------------------------------------------+--------------------+------------------+
</code></pre>
</div>
</div>
<p>The results are varied - in some instances the results align with our previous analysis - higher eduction, onsite, and tech should see higher salaries. For example, the first line and eigth line do have the highest salaries being in information and tech alongside 5+ years of experience, onsite, and higher education completed. However, the fith line has the lowest salary, but does not necessarily align in an intuitive sense - 10 years of experience, Masters, onsite, etc. should be ranked higher.</p>
<p>While the predictive power does show, fine tuning and additional model improvements can be made to improve the predictive capabilities.</p>
<p><strong>Clustering Analysis</strong></p>
<p>This clustering analysis explores salary and years of experience by the NAICS Name</p>
<div id="bf3160da" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># KMEANS by NAICS NAME</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> functions <span class="im">as</span> F</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml <span class="im">import</span> Pipeline</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.feature <span class="im">import</span> VectorAssembler, StandardScaler</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.clustering <span class="im">import</span> KMeans</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.evaluation <span class="im">import</span> ClusteringEvaluator</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>label_col <span class="op">=</span> <span class="st">"NAICS2_NAME"</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>numeric_features <span class="op">=</span> [<span class="st">"SALARY"</span>, <span class="st">"MIN_YEARS_EXPERIENCE"</span>]</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> (</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    rf_df.select(<span class="op">*</span>(numeric_features <span class="op">+</span> [label_col]))</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>         .withColumn(<span class="st">"SALARY"</span>, F.col(<span class="st">"SALARY"</span>).cast(<span class="st">"double"</span>))</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>         .withColumn(<span class="st">"MIN_YEARS_EXPERIENCE"</span>, F.col(<span class="st">"MIN_YEARS_EXPERIENCE"</span>).cast(<span class="st">"double"</span>))</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>         .na.drop(subset<span class="op">=</span>numeric_features <span class="op">+</span> [label_col])</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Using the log of salary to reduce skew and defining features before using them</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>base <span class="op">=</span> base.withColumn(<span class="st">"log_salary"</span>, F.log1p(F.col(<span class="st">"SALARY"</span>)))</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>features_for_model <span class="op">=</span> [<span class="st">"log_salary"</span>, <span class="st">"MIN_YEARS_EXPERIENCE"</span>]</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>assembler <span class="op">=</span> VectorAssembler(inputCols<span class="op">=</span>features_for_model, outputCol<span class="op">=</span><span class="st">"features_raw"</span>)</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>scaler    <span class="op">=</span> StandardScaler(inputCol<span class="op">=</span><span class="st">"features_raw"</span>, outputCol<span class="op">=</span><span class="st">"features"</span>, withMean<span class="op">=</span><span class="va">True</span>, withStd<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Finding the best k by silhouette method</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>label_count <span class="op">=</span> base.select(label_col).distinct().count()</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>k_candidates <span class="op">=</span> <span class="bu">sorted</span>({<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">8</span>, label_count})</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>evalr <span class="op">=</span> ClusteringEvaluator(featuresCol<span class="op">=</span><span class="st">"features"</span>, predictionCol<span class="op">=</span><span class="st">"prediction"</span>, metricName<span class="op">=</span><span class="st">"silhouette"</span>)</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>best_score, best_model <span class="op">=</span> <span class="op">-</span><span class="fl">1.0</span>, <span class="va">None</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k <span class="kw">in</span> [k <span class="cf">for</span> k <span class="kw">in</span> k_candidates <span class="cf">if</span> k <span class="op">&gt;=</span> <span class="dv">3</span>]:</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    km   <span class="op">=</span> KMeans(k<span class="op">=</span>k, seed<span class="op">=</span><span class="dv">42</span>, featuresCol<span class="op">=</span><span class="st">"features"</span>, predictionCol<span class="op">=</span><span class="st">"prediction"</span>)</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>    pipe <span class="op">=</span> Pipeline(stages<span class="op">=</span>[assembler, scaler, km]).fit(base)</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>    score <span class="op">=</span> evalr.evaluate(pipe.transform(base))</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> score <span class="op">&gt;</span> best_score:</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>        best_score, best_model <span class="op">=</span> score, pipe</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[Silhouette] k=</span><span class="sc">{</span>best_model<span class="sc">.</span>stages[<span class="op">-</span><span class="dv">1</span>]<span class="sc">.</span>getK()<span class="sc">}</span><span class="ss">  score=</span><span class="sc">{</span>best_score<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Prediction</span></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> best_model.transform(base).withColumnRenamed(<span class="st">"prediction"</span>, <span class="st">"cluster"</span>)</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>pdf <span class="op">=</span> pred.select(<span class="st">"cluster"</span>, label_col, <span class="op">*</span>features_for_model).toPandas()</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> adjusted_rand_score, normalized_mutual_info_score, homogeneity_score, completeness_score, v_measure_score</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np, pandas <span class="im">as</span> pd</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>y_c <span class="op">=</span> pdf[<span class="st">"cluster"</span>].to_numpy()</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>y_l <span class="op">=</span> pdf[label_col].astype(<span class="bu">str</span>).to_numpy()</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>ct <span class="op">=</span> pd.crosstab(y_c, y_l)         <span class="co"># purity</span></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>purity <span class="op">=</span> ct.<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>).<span class="bu">sum</span>() <span class="op">/</span> ct.values.<span class="bu">sum</span>()</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[Cluster â†’ top labels]"</span>)</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cl, row <span class="kw">in</span> ct.iterrows():</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>    top <span class="op">=</span> row.sort_values(ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">5</span>)</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Cluster </span><span class="sc">{</span>cl<span class="sc">}</span><span class="ss">: "</span> <span class="op">+</span> <span class="st">", "</span>.join([<span class="ss">f"</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">:</span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> k,v <span class="kw">in</span> top.items()]))</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarized data per cluster   </span></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>pred.groupBy(<span class="st">"cluster"</span>).agg(</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>    F.count(<span class="st">"*"</span>).alias(<span class="st">"n"</span>),</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>    F.avg(<span class="st">"SALARY"</span>).alias(<span class="st">"avg_salary"</span>),</span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>    F.avg(<span class="st">"MIN_YEARS_EXPERIENCE"</span>).alias(<span class="st">"avg_min_years_exp"</span>)</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>).orderBy(<span class="st">"cluster"</span>).show()</span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualizing the results</span></span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>plot_pdf <span class="op">=</span> pred.select(<span class="st">"MIN_YEARS_EXPERIENCE"</span>, <span class="st">"SALARY"</span>, <span class="st">"cluster"</span>) <span class="op">\</span></span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>               .sample(<span class="va">False</span>, <span class="fl">0.25</span>, <span class="dv">42</span>).toPandas()</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">6</span>))</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> plt.scatter(plot_pdf[<span class="st">"MIN_YEARS_EXPERIENCE"</span>], plot_pdf[<span class="st">"SALARY"</span>], c<span class="op">=</span>plot_pdf[<span class="st">"cluster"</span>], alpha<span class="op">=</span><span class="fl">.6</span>)</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"MIN_YEARS_EXPERIENCE"</span>)<span class="op">;</span> plt.ylabel(<span class="st">"SALARY"</span>)</span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Clustering by NAICS2"</span>)</span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>handles,_ <span class="op">=</span> s.legend_elements()</span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>plt.legend(handles, [<span class="ss">f"Cluster </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">sorted</span>(plot_pdf[<span class="st">'cluster'</span>].unique())], title<span class="op">=</span><span class="st">"Clusters"</span>)</span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">.3</span>)<span class="op">;</span> plt.tight_layout()<span class="op">;</span> plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 57:&gt;                                                         (0 + 1) / 1]                                                                                [Stage 63:&gt;                                                         (0 + 1) / 1]                                                                                [Stage 66:&gt;                                                         (0 + 1) / 1]                                                                                [Stage 69:&gt;                                                         (0 + 1) / 1]                                                                                [Stage 117:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 120:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 122:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 125:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 128:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 131:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 179:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 182:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 184:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 187:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 190:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 193:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 241:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 244:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 246:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 249:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 252:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 255:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 303:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 306:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 308:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 311:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 314:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 317:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 361:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 364:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 366:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 369:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 372:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 375:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 407:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 410:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 412:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 415:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 418:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 421:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 469:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 472:&gt;                                                        (0 + 1) / 1]                                                                                [Stage 474:&gt;                                                        (0 + 1) / 1]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[Silhouette] k=3  score=0.575</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 477:&gt;                                                        (0 + 1) / 1]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
[Cluster â†’ top labels]
Cluster 0: Professional, Scientific, and Technical Services:2722, Unclassified Industry:710, Finance and Insurance:702, Information:514, Administrative and Support and Waste Management and Remediation Services:462
Cluster 1: Professional, Scientific, and Technical Services:1212, Administrative and Support and Waste Management and Remediation Services:1073, Unclassified Industry:880, Finance and Insurance:826, Educational Services:563
Cluster 2: Professional, Scientific, and Technical Services:3270, Finance and Insurance:1577, Administrative and Support and Waste Management and Remediation Services:1093, Information:1019, Unclassified Industry:850</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 478:&gt;                                                        (0 + 1) / 1]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>+-------+-----+------------------+------------------+
|cluster|    n|        avg_salary| avg_min_years_exp|
+-------+-----+------------------+------------------+
|      0| 6348|156468.69848771265|10.139729048519218|
|      1| 6997| 74872.70701729313|2.8339288266399887|
|      2|10352| 133393.5200927357|  4.50396058732612|
+-------+-----+------------------+------------------+
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 481:&gt;                                                        (0 + 1) / 1]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RandomForest_files/figure-html/cell-10-output-8.png" width="758" height="566" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The KMeans cluster mostly uses salaries to seperate each cluster group - while some clusters pay lower or higher pay at the same years of experience, this suggests that the industry does influence salaries at different levels of experience. Overall, salaries generally rise with experience, though industry effects can override that pattern.</p>
<p><strong>Additional Analytics</strong></p>
<p>This section is to provide a quick salary state comparison</p>
<div id="8edd7540" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> functions <span class="im">as</span> F</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Average salary by state</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>state_salary <span class="op">=</span> (</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    rf_df</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>      .select(<span class="st">"STATE_NAME"</span>, <span class="st">"SALARY"</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>      .withColumn(<span class="st">"SALARY"</span>, F.col(<span class="st">"SALARY"</span>).cast(<span class="st">"double"</span>))</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>      .na.drop(subset<span class="op">=</span>[<span class="st">"STATE_NAME"</span>, <span class="st">"SALARY"</span>])</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>      .groupBy(<span class="st">"STATE_NAME"</span>)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>      .agg(</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>          F.count(<span class="st">"*"</span>).alias(<span class="st">"n_postings"</span>),</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>          F.avg(<span class="st">"SALARY"</span>).alias(<span class="st">"avg_salary"</span>),</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>          F.expr(<span class="st">"percentile_approx(SALARY, 0.5)"</span>).alias(<span class="st">"median_salary"</span>)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>      .orderBy(F.col(<span class="st">"avg_salary"</span>).desc())</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>state_salary.show(<span class="dv">60</span>, truncate<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Pandas table</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>tbl <span class="op">=</span> (</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    state_salary</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>      .withColumn(<span class="st">"avg_salary"</span>, F.<span class="bu">round</span>(<span class="st">"avg_salary"</span>, <span class="dv">0</span>))</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>      .withColumn(<span class="st">"median_salary"</span>, F.<span class="bu">round</span>(<span class="st">"median_salary"</span>, <span class="dv">0</span>))</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>      .orderBy(F.col(<span class="st">"avg_salary"</span>).desc())</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>      .toPandas()</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tbl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 482:&gt;                                                        (0 + 1) / 1]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>+---------------------------------------+----------+------------------+-------------+
|STATE_NAME                             |n_postings|avg_salary        |median_salary|
+---------------------------------------+----------+------------------+-------------+
|Connecticut                            |337       |132311.49554896142|128250.0     |
|Vermont                                |76        |130313.26315789473|121300.0     |
|New Jersey                             |639       |129825.1392801252 |127000.0     |
|California                             |2905      |129321.2464716007 |125900.0     |
|Delaware                               |131       |128099.2824427481 |124497.0     |
|Virginia                               |1039      |127059.95765158806|124900.0     |
|Washington                             |736       |127048.63451086957|122500.0     |
|Arkansas                               |255       |126950.65098039215|122195.0     |
|Massachusetts                          |591       |125961.12351945855|119500.0     |
|Illinois                               |959       |125788.52137643378|123850.0     |
|Nebraska                               |163       |125678.96319018405|123850.0     |
|Washington, D.C. (District of Columbia)|390       |124774.45128205128|118269.0     |
|Michigan                               |569       |124122.14411247802|125000.0     |
|Wisconsin                              |295       |123732.62033898305|123850.0     |
|Montana                                |86        |123239.25581395348|119240.0     |
|Georgia                                |624       |122651.26282051283|122195.0     |
|Maryland                               |484       |122621.85537190082|117500.0     |
|North Carolina                         |737       |122430.81818181818|123850.0     |
|Iowa                                   |251       |121902.98804780876|118500.0     |
|Texas                                  |1975      |121879.06481012658|120000.0     |
|Kansas                                 |260       |121805.66923076923|116500.0     |
|Oklahoma                               |249       |120403.7469879518 |120425.0     |
|Pennsylvania                           |573       |120339.40837696336|118500.0     |
|New York                               |1476      |120249.52574525746|113100.0     |
|Missouri                               |424       |120182.69103773584|117500.0     |
|Minnesota                              |507       |120115.28007889546|117500.0     |
|Idaho                                  |197       |119481.64467005077|120425.0     |
|South Carolina                         |204       |119466.04901960785|112800.0     |
|Florida                                |1147      |119453.30601569312|119350.0     |
|Wyoming                                |51        |119226.49019607843|107000.0     |
|Kentucky                               |211       |119131.01421800948|110700.0     |
|Maine                                  |141       |119006.82269503546|110000.0     |
|Rhode Island                           |171       |118844.18713450292|114400.0     |
|Ohio                                   |708       |118742.20338983051|118676.0     |
|Alabama                                |210       |118709.1761904762 |113520.0     |
|Indiana                                |300       |118553.04666666666|116448.0     |
|Tennessee                              |370       |118529.64864864865|116500.0     |
|Louisiana                              |153       |118171.94117647059|110685.0     |
|Hawaii                                 |120       |117889.175        |110155.0     |
|New Hampshire                          |113       |116386.54867256636|104884.0     |
|Arizona                                |577       |115707.33275563258|118000.0     |
|Colorado                               |738       |115357.58943089431|112382.0     |
|North Dakota                           |61        |113977.14754098361|105144.0     |
|Oregon                                 |510       |113884.91568627451|111370.0     |
|Utah                                   |216       |113842.82407407407|110685.0     |
|South Dakota                           |124       |110784.75         |100300.0     |
|West Virginia                          |49        |109530.10204081633|96750.0      |
|Alaska                                 |113       |108910.82300884956|95450.0      |
|Mississippi                            |147       |107830.13605442178|96750.0      |
|Nevada                                 |229       |104913.13973799127|102700.0     |
|New Mexico                             |106       |104371.09433962264|96750.0      |
+---------------------------------------+----------+------------------+-------------+
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 485:&gt;                                                        (0 + 1) / 1]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                 STATE_NAME  n_postings  avg_salary  \
0                               Connecticut         337    132311.0   
1                                   Vermont          76    130313.0   
2                                New Jersey         639    129825.0   
3                                California        2905    129321.0   
4                                  Delaware         131    128099.0   
5                                  Virginia        1039    127060.0   
6                                Washington         736    127049.0   
7                                  Arkansas         255    126951.0   
8                             Massachusetts         591    125961.0   
9                                  Illinois         959    125789.0   
10                                 Nebraska         163    125679.0   
11  Washington, D.C. (District of Columbia)         390    124774.0   
12                                 Michigan         569    124122.0   
13                                Wisconsin         295    123733.0   
14                                  Montana          86    123239.0   
15                                  Georgia         624    122651.0   
16                                 Maryland         484    122622.0   
17                           North Carolina         737    122431.0   
18                                     Iowa         251    121903.0   
19                                    Texas        1975    121879.0   
20                                   Kansas         260    121806.0   
21                                 Oklahoma         249    120404.0   
22                             Pennsylvania         573    120339.0   
23                                 New York        1476    120250.0   
24                                 Missouri         424    120183.0   
25                                Minnesota         507    120115.0   
26                                    Idaho         197    119482.0   
27                           South Carolina         204    119466.0   
28                                  Florida        1147    119453.0   
29                                  Wyoming          51    119226.0   
30                                 Kentucky         211    119131.0   
31                                    Maine         141    119007.0   
32                             Rhode Island         171    118844.0   
33                                     Ohio         708    118742.0   
34                                  Alabama         210    118709.0   
35                                  Indiana         300    118553.0   
36                                Tennessee         370    118530.0   
37                                Louisiana         153    118172.0   
38                                   Hawaii         120    117889.0   
39                            New Hampshire         113    116387.0   
40                                  Arizona         577    115707.0   
41                                 Colorado         738    115358.0   
42                             North Dakota          61    113977.0   
43                                   Oregon         510    113885.0   
44                                     Utah         216    113843.0   
45                             South Dakota         124    110785.0   
46                            West Virginia          49    109530.0   
47                                   Alaska         113    108911.0   
48                              Mississippi         147    107830.0   
49                                   Nevada         229    104913.0   
50                               New Mexico         106    104371.0   

    median_salary  
0        128250.0  
1        121300.0  
2        127000.0  
3        125900.0  
4        124497.0  
5        124900.0  
6        122500.0  
7        122195.0  
8        119500.0  
9        123850.0  
10       123850.0  
11       118269.0  
12       125000.0  
13       123850.0  
14       119240.0  
15       122195.0  
16       117500.0  
17       123850.0  
18       118500.0  
19       120000.0  
20       116500.0  
21       120425.0  
22       118500.0  
23       113100.0  
24       117500.0  
25       117500.0  
26       120425.0  
27       112800.0  
28       119350.0  
29       107000.0  
30       110700.0  
31       110000.0  
32       114400.0  
33       118676.0  
34       113520.0  
35       116448.0  
36       116500.0  
37       110685.0  
38       110155.0  
39       104884.0  
40       118000.0  
41       112382.0  
42       105144.0  
43       111370.0  
44       110685.0  
45       100300.0  
46        96750.0  
47        95450.0  
48        96750.0  
49       102700.0  
50        96750.0  </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                </code></pre>
</div>
</div>



</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>